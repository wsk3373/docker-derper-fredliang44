services:
  derper:
    build: .
    container_name: derper
    restart: ${RESTART_POLICY:-unless-stopped}
    ports:
      - "${DERP_HTTPS_PORT}:4443"
      - "${STUN_PORT}:3478/udp"
    volumes:
      - /var/run/tailscale/tailscaled.sock:/var/run/tailscale/tailscaled.sock
      - ./certs:/app/certs
      - ./data:/var/lib/derper
      - ./logs:/var/log/derper
    environment:
      - TZ=${TZ}
      - DERP_HOSTNAME=${DERP_HOSTNAME}
      - DERP_CERT_MODE=${DERP_CERT_MODE}
      - DERP_VERIFY_CLIENTS=${DERP_VERIFY_CLIENTS}
      - DERP_STUN=true
      - DERP_STUN_PORT=${STUN_PORT}
    networks:
      - traefik_net
    # ğŸ”§ æ·»åŠ ä»¥ä¸‹å‘½ä»¤é…ç½®ï¼Œè¦†ç›–é•œåƒçš„é»˜è®¤å¯åŠ¨æ–¹å¼
    command:
      - "/app/derper"
      - "--hostname=${DERP_HOSTNAME}"
      - "--certmode=${DERP_CERT_MODE}"
      - "--certdir=/app/certs"
      - "-a=:4443"
      - "--stun"
      - "--stun-port=${STUN_PORT}"
      - "--verify-clients=${DERP_VERIFY_CLIENTS}"

networks:
  traefik_net:
    external: true
